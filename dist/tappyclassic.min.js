!function(e,t){if("function"==typeof define&&define.amd)define(["ndef"],t);else if("object"==typeof exports){var n=null;try{n=require("@taptrack/ndef")}catch(r){n=require("ndef")}module.exports=t(n)}else e.TappyClassic=t(e.Ndef)}(this,function(e){var t=function(){throw"Do not instantiate TappyUtils"};t.bytesToHexString=function(e){for(var t="",n=0;n<e.length;n++){var r=e[n].toString(16).toUpperCase();t=e[n]<=15?t.concat("0"+r):t.concat(r)}return t},t.bytesToString=function(e){var t=Array.prototype.map.call(e,function(e){return String.fromCharCode(e)}).join(""),n=t.replace(/(.)/g,function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n});return decodeURIComponent(n)},t.stringToUint8Array=function(e){var t=encodeURIComponent(e),n=t.replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}),r=new Uint8Array(n.length);return Array.prototype.forEach.call(n,function(e,t){r[t]=e.charCodeAt(0)}),r},t.resolveTagTypeDescription=function(e){var t="Unknown";switch(e){case 0:t="Unknown Tag";break;case 1:t="Mifare Ultralight";break;case 2:t="NTAG 203";break;case 3:t="Mifare Ultralight C";break;case 4:t="Mifare Classic Standard - 1k";break;case 5:t="Mifare Classic Standard - 4k";break;case 6:t="Mifare DESFire EV1 2k";break;case 7:t="Generic NFC Forum Type 2 tag";break;case 8:t="Mifare Plus 2k CL2";break;case 9:t="Mifare Plus 4k CL2";break;case 10:t="Mifare Mini";break;case 11:t="Generic NFC Forum Type 4 tag";break;case 12:t="Mifare DESFire EV1 4k";break;case 13:t="Mifare DESFire EV1 8k";break;case 14:t="Mifare DESFire - Unspecified model and capacity";break;case 15:t="Topaz 512";break;case 16:t="NTAG 210";break;case 17:t="NTAG 212";break;case 18:t="NTAG 213";break;case 19:t="NTAG 215";break;case 20:t="NTAG 216"}return t};var n=function(){this.ackResponseCb=null,this.nackResponseCb=null,this.lcsErrorResponseCb=null,this.dcsErrorResponseCb=null,this.serialPortErrorCb=null,this.validResponseFrameCb=null},r=function(){this.verboseLogging=!1,this.postambleLength=2,this.preambleLength=2,this.lcsErrorStrategy=a.EMPTY_BUFFER_ON_LCS_ERR,this.safeSendWaitTime=25},a=function(e,t){if("undefined"==typeof e||null===e)throw"Must have a path";var a=new r,o=t||{};for(var i in a)a.hasOwnProperty(i)&&!o.hasOwnProperty(i)&&(o[i]=a[i]);var s=this;this.path=e,this.connectionId=null,this.isConnecting=!1,this.hasAttached=!1,this.disconnectImmediately=!1,this.postambleLength=o.postambleLength,this.preambleLength=o.preambleLength,this.verboseLogging=o.verboseLogging,this.lcsErrorStrategy=o.lcsErrorStrategy,this.safeSendWaitTime=o.safeSendWaitTime,this.pendingOperation=null,this.bufferedData=new Uint8Array(0),this.onReceiveCallback=function(e){var t=e.connectionId,n=e.data;if(s.isConnected()&&t===s.connectionId){s.log("Data received");var r=new Uint8Array(n),a=new Uint8Array(s.bufferedData.length+r.length);a.set(s.bufferedData),a.set(r,s.bufferedData.length),s.bufferedData=a,s.log("Buffer status:"),s.log(s.bufferedData),s.scanBufferAndDispatch()}},this.callbacks=new n};a.FRAME_SIZE_NO_DATA=6,a.FRAME_SIZE_N_ACK=8,a.EMPTY_BUFFER_ON_LCS_ERR=0,a.REMOVE_ONLY_BAD_START_ON_LCS_ERR=1,a.RAW_RESET_INS=new Uint8Array([0,255,0,1,255,0,0]),a.CommandCodes={RESET:0,STOP:39},a.APPLICATION_ERROR_CODE=127,a.ErrorTypes={NACK:1,LCS:2,DCS:3,APPLICATION:4,SERIAL:5,BAD_RESPONSE:6},a.prototype.log=function(e){this.verboseLogging&&console.log(e)},a.prototype.connect=function(e){if(!this.isConnecting&&!this.isConnected()){var t=this;this.isConnecting=!0,t.log("Starting connect"),chrome.serial.connect(this.path,{bitrate:115200},function(n){chrome.runtime.lastError?(t.log("Error connecting: "+chrome.runtime.lastError.message),t.isConnecting=!1,"function"==typeof e&&e()):(t.connectionId=n.connectionId,t.log("Connected with connection id "+t.connectionId),t.attachReadWrite(),t.isConnecting=!1,"function"==typeof e&&e(),t.disconnectImmediately&&(t.log("Immediate disconnect requested"),t.disconnect()))})}},a.prototype.disconnectAsap=function(){this.log("Disconnecting as soon as possible"),this.disconnectImmediately=!0,!this.isConnecting&&this.isConnected()&&this.disconnect()},a.prototype.disconnect=function(){if(this.isConnecting)throw"Connection still in the process of being established";if(this.isConnected()){var e=this;e.log("Starting to disconnect from connection with id "+this.connectionId);var t=this.connectionId;e.connectionId=null,chrome.serial.disconnect(t,function(t){t?e.log("Disconnected"):e.log("Disconnect failed")})}},a.prototype.isConnected=function(){return null!==this.connectionId},a.prototype.attachReadWrite=function(){this.hasAttached||(this.hasAttached=!0,chrome.serial.onReceive.addListener(this.onReceiveCallback))},a.prototype.scanBufferAndDispatch=function(){if(this.bufferedData.length>=a.FRAME_SIZE_NO_DATA){for(var e=!1,t=0,n=0;n<this.bufferedData.length-1;n++)if(0===this.bufferedData[n]&&255===this.bufferedData[n+1]){var r=a.extractFrame(n,this.bufferedData);r.isDcsError?(this.log("Dcs error:"),this.log(r.frame),e=!0,"function"==typeof this.callbacks.dcsErrorResponseCb&&this.callbacks.dcsErrorResponseCb(r.frame),t=r.lastIndex+1):r.isAck?(this.log("Ack received"),e=!0,"function"==typeof this.callbacks.ackResponseCb&&this.callbacks.ackResponseCb(),t=r.lastIndex+1):r.isNack?(this.log("Nack received"),e=!0,"function"==typeof this.callbacks.nackResponseCb&&this.callbacks.nackResponseCb(),t=r.lastIndex+1):r.isComplete?(this.log("Complete frame received"),this.log(r.frame),e=!0,"function"==typeof this.callbacks.validResponseFrameCb&&this.callbacks.validResponseFrameCb(r.frame),t=r.lastIndex+1):r.isLcsError?(this.log("Lcs error:"),this.log(this.bufferedData.slice(n)),e=!0,"function"==typeof this.callbacks.lcsErrorResponseCb&&this.callbacks.lcsErrorResponseCb(this.bufferedData.slice(n)),t=this.lcsErrorStrategy===a.EMPTY_BUFFER_ON_LCS_ERR?this.bufferedData.length:n+5):(this.log("No full frame found"),e=!1,t=n);break}t>=this.bufferedData.length?this.bufferedData=new Uint8Array(0):t>0&&(this.bufferedData=this.bufferedData.slice(t,this.bufferedData.length)),e&&this.scanBufferAndDispatch()}};var o=function(e,t,n,r,a,o){this.frame=e,this.isComplete=null!==e,this.isAck=a,this.isNack=o,this.isLcsError=n,this.isDcsError=r,this.lastIndex=t};a.extractFrame=function(e,t){if(t.length<e+a.FRAME_SIZE_NO_DATA)return new o(null,-1,!1,!1,!1,!1);var n=t[e+2],r=t[e+3],i=t[e+4],s=256*n+r;if((r+n+i)%256!==0)return new o(null,-1,!0,!1,!1,!1);if(2===s&&t.length>=e+a.FRAME_SIZE_N_ACK){if(0===t[e+5]&&255===t[e+6]&&1===t[e+7])return new o(t.slice(e,e+8),e+7,!1,!1,!0,!1);if(255===t[e+5]&&255===t[e+6]&&2===t[e+7])return new o(t.slice(e,e+8),e+7,!1,!1,!1,!0)}var c=e+a.FRAME_SIZE_NO_DATA+s,l=c-1;if(c>t.length)return new o(null,-1,!1,!1,!1,!1);var d=t.slice(e,c);if(0===s)return 0===d[d.length-1]?new o(d,l,!1,!1,!1,!1):new o(d,l,!1,!0,!1,!1);for(var f=0,h=0;s>h;h++){var u=e+h+5;f+=t[u]}return f+=d[d.length-1],f%256!==0?new o(d,l,!1,!0,!1,!1):new o(d,l,!1,!1,!1,!1)},a.prototype.safeSendCommand=function(e,t,n){if(t.length>65534)throw"Command too long";"object"==typeof n?this.safeSendRaw(this.composeCommand(e,t),n):this.safeSendRaw(this.composeCommand(e,t))},a.prototype.safeSendRaw=function(e,t){var r=this;if("undefined"==typeof e)throw"Cannot send no data";if(!this.isConnected())throw"Cannot send while not connected";var o=null;if("object"==typeof t&&null!==t){var i=new n,s=t||{};for(var c in i)i.hasOwnProperty(c)&&!s.hasOwnProperty(c)&&(s[c]=i[c]);o=s}else o=this.callbacks;this.pendingOperation=function(){r.callbacks=o,r.log("Sending raw after wait command:"),r.log(new Uint8Array(e)),r.sendRaw(e)};var l=function(){r.callbacks=new n,chrome.serial.flush(r.connectionId,function(e){r.callbacks=o,r.log("Emptying buffer after reset, current state is"),r.log(r.bufferedData),r.bufferedData=new Uint8Array(0),null!==r.pendingOperation&&(r.pendingOperation(),r.pendingOperation=null)})},d=new n;d.ackResponseCb=l,d.nackResponseCb=l,d.lcsErrorResponseCb=l,d.dcsErrorResponseCb=l,d.serialPortErrorCb=l,d.validResponseFrameCb=function(e){r.log("Valid frame in transient time for safe send"),r.log(e),e.length>6&&127===e[5]&&e[6]===a.CommandCodes.STOP&&(r.log("Unrecognized command for STOP, this Tappy probably predates STOP"),l())},this.log("Emptying buffer, current state is"),this.log(this.bufferedData),this.bufferedData=new Uint8Array(0),this.callbacks=d,this.sendCommand(a.CommandCodes.STOP)},a.prototype.sendCommand=function(e,t){this.sendRaw(this.composeCommand(e,t))},a.prototype.composeCommand=function(e,t){if("undefined"!=typeof t&&null!==t||(t=new Uint8Array(0)),t.length>65534)throw"Command too long";for(var n=new Uint8Array(7+t.length+this.preambleLength+this.postambleLength),r=0,a=0;a<this.preambleLength;a++)n[r]=0,r++;n[r++]=0,n[r++]=255;var o=t.length+1,i=Math.floor(o/256),s=o%256,c=i+s,l=256-c;n[r++]=i,n[r++]=s,n[r++]=l,n[r++]=e;for(var d=e,f=0;f<t.length;f++)n[r++]=t[f],d+=t[f];n[r++]=256-d%256;for(var h=0;h<this.postambleLength;h++)n[r]=0,r++;return n.buffer},a.prototype.sendRaw=function(e){if("undefined"==typeof e)throw"Cannot send no data";if(!this.isConnected())throw"Cannot send while not connected";var t=this;t.log("Attempting send:"),t.log(new Uint8Array(e)),chrome.serial.send(this.connectionId,e,function(n){n.hasOwnProperty("error")&&null!==n.error&&(t.log("A send error occured, received:"),t.log(n),"function"==typeof t.callbacks.serialPortErrorCb&&t.callbacks.serialPortErrorCb(n,e))})},a.prototype.setCallbacks=function(e){var t=new n,r=e||{};for(var a in t)t.hasOwnProperty(a)&&!r.hasOwnProperty(a)&&(r[a]=t[a]);this.callbacks=r},a.generateStandardCallbacks=function(e,t,n){var r=function(){};e="undefined"!=typeof e&&null!==e?e:r,t="undefined"!=typeof t&&null!==t?t:r,n="undefined"!=typeof n&&null!==n?n:r;var o={};return o.ackResponseCb=function(){n()},o.nackResponseCb=function(){t(a.ErrorTypes.NACK,{})},o.lcsErrorResponseCb=function(e){t(a.ErrorTypes.LCS,{buffer:e})},o.dcsErrorResponseCb=function(e){t(a.ErrorTypes.DCS,{frame:e})},o.serialPortErrorCb=function(e,n){t(a.ErrorTypes.SERIAL,{sendInfo:e,data:n})},o.validResponseFrameCb=function(n){var r=n.slice(5,n.length-1);if(r[0]===a.APPLICATION_ERROR_CODE&&r.length>=4){var o=r[2],i=a.getDetailForGlobalErrorCode(o);null!==i?t(a.ErrorTypes.APPLICATION,{commandCode:r[1],errorCode:r[2],nfcChipError:r[3],detail:i}):t(a.ErrorTypes.APPLICATION,{commandCode:r[1],errorCode:r[2],nfcChipError:r[3]})}else e(r)},o},a.getDetailForGlobalErrorCode=function(e){var t=null;switch(e){case 1:t="Invalid content slot number.";break;case 2:t="Invalid content type.";break;case 3:t="NDEF message too big";break;case 4:t="vCard lengths not received";break;case 5:t="vCard length mismatch";break;case 6:t="vCard delimiters missing";break;case 7:t="vCard parameter length mismatch";break;case 8:t="A scanning error has occurred.";break;case 9:t="An unrecognized command has been given.";break;case 10:t="Invalid content slot order for export";break;case 11:t="Content slot was not populated with content.";break;case 12:t="NDEF formatting error - the OTP bytes are already set to non-NDEF.";break;case 13:t="The tag appears to be locked and cannot be written.";break;case 14:t="Unsupported tag type";break;case 15:t="An error occured locking the tag";break;case 16:t="Tag operation timed out";break;case 17:t="An error occured formatting MIFARE Classic application directory sector trailer";break;case 18:t="An error occured MIFARE Classic sector trailer for NDEF";break;case 19:t="An error occured writing MIFARE Classic data blocks";break;case 20:t="Incorrect NONCE size";break;case 21:t="No previous packet";break;case 22:t="Invalid picker number";break;case 23:t="Error adding picker tag";break;case 24:t="Error getting bin count";break;case 25:t="Error clearing bin count";break;case 26:t="Tag already allocated";break;case 27:t="Secondary oscillator not ready, cannot set date/time";break;case 28:t="Real-time clock not ready";break;case 29:t="Tag not wristband compatible";break;case 30:t="Guest data data out of bounds";break;case 31:t="Guest number exceeds maximum";break;case 32:t="An error occured creating guest wristband";break;case 33:t="An error occured reading guest count";break;case 34:t="Counter number invalid";break;case 35:t="Error clearing wristband counter";break;case 36:t="Out of bounds";break;case 37:t="Authentication failed";break;case 38:t="Error reading passport datagroup";break;case 39:t="Incorrect number of parameters";break;case 40:t="Provisioning failed";break;case 41:t="An error occured while attempting to format tag as NDEF";break;case 42:t="Field number exceeds maximum";break;case 43:t="Field number not set";break;case 44:t="Improper URL format";break;case 45:t="Required URL not set";break;case 46:t="Corrupt field data";break;case 47:t="Required field not set";break;case 48:t="Multirecord text field number exceeds maximum";break;case 49:t="Multirecord text field number not set";break;case 50:t="Multirecord text field not set";break;case 51:t="Multirecord text field data corrupted";break;case 52:t="Invalid password diversification method";break;case 53:t="Incorrect salt length";break;case 54:t="Formatting error";break;case 55:t="No NDEF data found";break;case 56:t="Unrecognized NDEF version";break;case 57:t="Problem reading NDEF data";break;case 58:t="Incorrect UID length for password diversification";break;case 252:t="A unknown error has occurred.";break;default:t="A unrecognized error has occurred."}return t},a.CommandCodes.ADD_CONTENT=2,a.CommandCodes.EMULATE_CONTENT=3,a.CommandCodes.READ_TAG_UID=7,a.CommandCodes.WRITE_TAG=8,a.CommandCodes.WRITE_TEXT_NDEF=9,a.CommandCodes.READ_NDEF=38,a.CommandCodes.LOCK_TAG=19,a.CommandCodes.WRITE_CUSTOM_NDEF=41,a.CommandCodes.SCAN_TYPE_4B=42,a.prototype.readTagUid=function(e,t,n,r,o){n="function"==typeof n?n:function(){},r="function"==typeof r?r:function(){},o="function"==typeof o?o:function(){};var i=function(e){if(e.length<5)r(a.ErrorTypes.BAD_PARSE,{response:e});else{var t=e[0],o=e[1],i=e.slice(2,2+o);4!=i.length&&7!=i.length&&10!=i.length?r(a.ErrorTypes.BAD_RESPONSE,{response:e,detail:"Tag code is an invalid length"}):n(t,i)}},s=t?0:1,c=a.generateStandardCallbacks(i,r,o);this.safeSendCommand(a.CommandCodes.READ_TAG_UID,new Uint8Array([e,s]),c)},a.prototype.readNdef=function(t,n,r,o){n="function"==typeof n?n:function(){},r="function"==typeof r?r:function(){},o="function"==typeof o?o:function(){};var i=function(t){if(t.length<6)r(a.ErrorCodes.BAD_PARSE,{response:t});else{var o=t[0],i=t[1];if(4!=i&&7!=i&&10!=i)r(a.ErrorTypes.BAD_RESPONSE,{response:t,detail:"Tag code is an invalid length"});else if(t.length<2+i)r(a.ErrorTypes.BAD_RESPONSE,{response:t,detail:"Frame too short to contain tag code"});else{var s=t.slice(2,2+i),c=t.slice(2+i),l=null;try{l=e.Message.fromBytes(c)}catch(d){return void r(a.ErrorTypes.BAD_RESPONSE,{response:t,detail:"Exception thrown attempting to parse: "+d})}null!==l?n(o,s,l):r(a.ErrorTypes.BAD_RESPONSE,{response:t,detail:"NdefMessage parse to failed"})}}},s=a.generateStandardCallbacks(i,r,o);this.safeSendCommand(a.CommandCodes.READ_NDEF,new Uint8Array([t]),s)},a.ContentSlotTypes={URI:1,TEXT:2,VCARD:4,EMPTY:153},a.prototype.addContent=function(e,t,n,r,o,i,s){o="function"==typeof o?o:function(){},i="function"==typeof i?i:function(){},s="function"==typeof s?s:function(){};var c=new Uint8Array(3+r.length);c[0]=e,c[1]=t,c[2]=n,c.set(r,3);var l=function(e,t){e===a.ErrorTypes.APPLICATION&&t.commandCode===a.CommandCodes.ADD_CONTENT&&3===t.errorCode&&(t.detail="NDEF message too big (exceeds 8096 bytes)."),i(e,t)},d=function(){o(),s()},f=a.generateStandardCallbacks(o,l,d);this.safeSendCommand(a.CommandCodes.ADD_CONTENT,c,f)},a.TappyVcard=function(){this.name="",this.cellPhone="",this.workPhone="",this.homePhone="",this.personalEmail="",this.businessEmail="",this.homeAddress="",this.workAddress="",this.company="",this.title="",this.url=""},a.prototype.addVcardContent=function(e,n,r,o,i){var s=new a.TappyVcard,c=n||{};for(var l in s)s.hasOwnProperty(l)&&!c.hasOwnProperty(l)&&(c[l]=s[l]);var d=10,f=t.stringToUint8Array(n.name);d+=f.length;var h=t.stringToUint8Array(n.cellPhone);d+=h.length;var u=t.stringToUint8Array(n.workPhone);d+=u.length;var p=t.stringToUint8Array(n.homePhone);d+=p.length;var g=t.stringToUint8Array(n.personalEmail);d+=g.length;var C=t.stringToUint8Array(n.businessEmail);d+=C.length;var b=t.stringToUint8Array(n.homeAddress);d+=b.length;var m=t.stringToUint8Array(n.workAddress);d+=m.length;var y=t.stringToUint8Array(n.company);d+=y.length;var E=t.stringToUint8Array(n.title);d+=E.length;var k=t.stringToUint8Array(n.url);d+=k.length;var A=0,v=new Uint8Array(d);v.set(f,A),A+=f.length,v[A++]=44,v.set(h,A),A+=h.length,v[A++]=44,v.set(u,A),A+=u.length,v[A++]=44,v.set(p,A),A+=p.length,v[A++]=44,v.set(g,A),A+=g.length,v[A++]=44,v.set(C,A),A+=C.length,v[A++]=44,v.set(b,A),A+=b.length,v[A++]=44,v.set(m,A),A+=m.length,v[A++]=44,v.set(y,A),A+=y.length,v[A++]=44,v.set(E,A),A+=E.length,v[A++]=44,v.set(k,A),A+=k.length;var T=new Uint8Array(12+d);T[0]=128,T[1]=f.length,T[2]=h.length,T[3]=u.length,T[4]=p.length,T[5]=g.length,T[6]=C.length,T[7]=b.length,T[8]=m.length,T[9]=y.length,T[10]=E.length,T[11]=k.length,T.set(v,12),this.addContent(e,a.ContentSlotTypes.VCARD,0,T,r,o,i)},a.prototype.addTextContent=function(e,t,n,r,a,o,i){var s=function(e){var t=encodeURIComponent(e),n=t.replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}),r=new Uint8Array(n.length);return Array.prototype.forEach.call(n,function(e,t){r[t]=e.charCodeAt(0)}),r};this.addContent(e,t,n,s(r),a,o,i)},a.prototype.writeTextNdef=function(e,n,r,o,i,s){o="function"==typeof o?o:function(){},i="function"==typeof i?i:function(){},s="function"==typeof s?s:function(){};var c=function(e){if(e.length<5)i(a.ErrorTypes.BAD_PARSE,{response:e});else{var t=e[0],n=e[1],r=e.slice(2,2+n);4!=r.length&&7!=r.length&&10!=r.length?i(a.ErrorTypes.BAD_RESPONSE,{response:e,detail:"Tag code is an invalid length"}):o(t,r)}},l=t.stringToUint8Array(r),d=new Uint8Array(2+l.length);d[0]=e,d[1]=n?1:0,d.set(l,2);var f=a.generateStandardCallbacks(c,i,s);this.safeSendCommand(a.CommandCodes.WRITE_TEXT_NDEF,d,f)},a.prototype.emulateContent=function(e,t,n,r,o,i,s){o="function"==typeof o?o:function(){},i="function"==typeof i?i:function(){},s="function"==typeof s?s:function(){};var c=new Uint8Array(5);c[0]=e,c[1]=t?1:0,c[2]=n,c[3]=r>>8&255,c[4]=255&r;var l=function(){o(),s()},d=a.generateStandardCallbacks(o,i,l);this.safeSendCommand(a.CommandCodes.EMULATE_CONTENT,c,d)},a.prototype.writeContentToTag=function(e,t,n,r,o){n="function"==typeof n?n:function(){},r="function"==typeof r?r:function(){},o="function"==typeof o?o:function(){};var i=function(e){if(e.length<7)r(a.ErrorCodes.BAD_PARSE,{response:e});else{var t=e[0],o=0!==e[1],i=e[2];if(4!=i&&7!=i&&10!=i)r(a.ErrorTypes.BAD_RESPONSE,{response:e,detail:"Tag code is an invalid length"});else if(e.length<3+i)r(a.ErrorTypes.BAD_RESPONSE,{response:e,detail:"Frame too short to contain tag code"});else{var s=e.slice(3,3+i);n(t,s,o)}}},s=new Uint8Array(10);s[0]=e,s[1]=t?1:0;for(var c=2;10>c;c++)s[c]=0;var l=a.generateStandardCallbacks(i,r,o);this.safeSendCommand(a.CommandCodes.WRITE_TAG,s,l)},a.prototype.sendStop=function(e,t,n){var r=new Uint8Array(0),o=function(){e(),n()},i=a.generateStandardCallbacks(e,t,o);this.safeSendCommand(a.CommandCodes.STOP,r,i)},a.prototype.lockTag=function(e,t,n,r){t="function"==typeof t?t:function(){},n="function"==typeof n?n:function(){},r="function"==typeof r?r:function(){};var o=function(e){if(e.length<6)n(a.ErrorCodes.BAD_PARSE,{response:e});else{var r=e[0],o=e[1];if(4!=o&&7!=o&&10!=o)n(a.ErrorTypes.BAD_RESPONSE,{response:e,detail:"Tag code is an invalid length"});else if(e.length<2+o)n(a.ErrorTypes.BAD_RESPONSE,{response:e,detail:"Frame too short to contain tag code"});else{var i=e.slice(2,2+o);t(r,i)}}},i=a.generateStandardCallbacks(o,n,r);this.safeSendCommand(a.CommandCodes.LOCK_TAG,new Uint8Array([e]),i)},a.prototype.writeCustomNdef=function(e,t,n,r,o,i){r="function"==typeof r?r:function(){},o="function"==typeof o?o:function(){},i="function"==typeof i?i:function(){};var s=function(e){if(e.length<5)erroParserCb(a.ErrorCodes.BAD_PARSE,{response:e});else{var t=e[0],n=e.slice(1);r(t,n)}},c=new Uint8Array(2+n.length);c[0]=e,c[1]=t?1:0,c.set(n,2);var l=a.generateStandardCallbacks(s,o,i);this.safeSendCommand(a.CommandCodes.WRITE_CUSTOM_NDEF,c,l)},a.prototype.scanType4B=function(e,t,n,r){t="function"==typeof t?t:function(){},n="function"==typeof n?n:function(){},r="function"==typeof r?r:function(){};var o=function(e){if(e.length<2)n(a.ErrorTypes.BAD_PARSE,{response:e});else{var r=e[0],o=e[1];if(e.length<2+r+o)n(a.ErrorTypes.BAD_PARSE,{response:e});else{var i=e.slice(2,2+r),s=e.slice(2+r,2+r+o);t(i,s)}}},i=a.generateStandardCallbacks(o,n,r);this.safeSendCommand(a.CommandCodes.SCAN_TYPE_4B,new Uint8Array([e]),i)};var i=function(){this.isCancelled=!0,this.detectedCallback=null,this.ackWaitTimeout=100,this.statusCallback=null,this.latestScanId=0};return i.prototype.setCallback=function(e){if("function"!=typeof e&&null!==e)throw"Callback must be a function or null";this.detectedCallback=e},i.prototype.setStatusCallback=function(e){if("function"!=typeof e&&null!==e)throw"Callback must be a function or null";this.statusCallback=e},i.prototype.cancelScan=function(){var e=this;e.isCancelled=!0,e.notifyListenerOfStatus()},i.prototype.isScanCancelled=function(){return this.isCancelled},i.prototype.isScanning=function(){return!this.isScanCancelled()},i.prototype.notifyListenerOfTappy=function(e){this.isCancelled||null===this.detectedCallback||this.detectedCallback(e)},i.prototype.notifyListenerOfStatus=function(){null!==this.statusCallback&&this.statusCallback(this.isScanning())},i.prototype.getLatestScanId=function(){return this.latestScanId},i.prototype.startScan=function(){var e=this;e.latestScanId++;var t=e.latestScanId;e.isCancelled=!1,e.notifyListenerOfStatus(),chrome.serial.getDevices(function(n){for(var r=new i.Channel(t,n.length,e),a=0;a<n.length&&!e.isCancelled;a++){var o=n[a];console.log("Trying"),console.log(o);var s=new i.DeviceDelegate(o,r,e.ackWaitTimeout);s.initiate()}0===n.length&&e.cancelScan()})},i.Channel=function(e,t,n){this.channelScanId=e,this.deviceCheckedCount=0,this.totalDeviceCount=t,this.detector=n},i.Channel.prototype.notifyListenerOfTappy=function(e){var t=this;t.detector.getLatestScanId()===t.channelScanId&&t.detector.notifyListenerOfTappy(e)},i.Channel.prototype.deviceCheckCompleted=function(){var e=this;e.deviceCheckedCount++,e.deviceCheckedCount===e.totalDeviceCount&&e.detector.getLatestScanId()===e.channelScanId&&e.detector.cancelScan()},i.Channel.prototype.abortDesired=function(){var e=this;return e.detector.isScanCancelled()||e.detector.getLatestScanId()!==e.channelScanId},i.DeviceDelegate=function(e,t,n){this.device=e,this.channel=t,this.tappy=new a(e.path),this.timeout=n},i.DeviceDelegate.prototype.initiate=function(){var e=this;e.tappy.connect(function(){if(!e.tappy.isConnected()||e.channel.abortDesired())e.tappy.disconnectAsap(),e.channel.deviceCheckCompleted();else{var t=a.RAW_RESET_INS;e.tappy.setCallbacks({ackResponseCb:function(){e.tappy.disconnectAsap(),e.channel.notifyListenerOfTappy(e.device)}}),e.tappy.sendRaw(t.buffer),setTimeout(function(){e.tappy.disconnectAsap(),e.channel.deviceCheckCompleted()},e.timeout)}})},a.Autodetector=i,a.Utils=t,a});